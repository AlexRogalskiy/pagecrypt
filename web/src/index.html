<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="style.css">
    <title>Protected Page</title>
</head>

<body>
    <iframe class="hidden w-full h-screen" allowfullscreen></iframe>

    <main class="bg-yellow-200 w-full h-screen flex items-start justify-center tracking-wide font-light">
        <div class="max-w-sm w-full bg-gray-50 p-4 rounded-sm shadow-2xl mt-40">
            <header class="flex gap-2 mb-4">
                <svg id="locked" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"
                    xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd"
                        d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                        clip-rule="evenodd"></path>
                </svg>
                <svg id="unlocked" class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20"
                    xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2H7V7a3 3 0 015.905-.75 1 1 0 001.937-.5A5.002 5.002 0 0010 2z">
                    </path>
                </svg>
                <p id="msg">This page is password protected.</p>
            </header>
            <form>
                <input type="password" id="pwd" name="pwd" aria-label="Password" autofocus placeholder="Password"
                    class="font-extralight bg-gray-200 flex w-full py-2 px-4 tracking-wider rounded-sm focus:outline-none text-black placeholder-black text-opacity-100 focus:border-black border" />
            </form>
        </div>
    </main>

    <script type="module">
        import forge from 'node-forge'

        // Testing:
        // const pl = {
        //     iv: 'ASvFwFAu+NTqSSNg/HWVcA==',
        //     tag: 'PYPZ4iEfWFxxrXuNxG8dvw==',
        //     salt: 'ax2oMu4ULtwV+5sJq0cgHl9ybbQENFNHq9eGDT5yT92hcykgRHYqpmxkzB4zpOel2D/7EL/kpxrSQhVB/cYTfZ4vC9xQLmWMZGYNfvOwTl26b4G6nV0hf3J4b7VW7uuY69S2V+Oh5TW60o6JDGCSTAzKLFO9DAP4ZvsS6XFOtsEQ4XVcVnklLD1R54XEPr+njQZ3pR0VCPRUcq24SMK10Owc2CfCu3D5pzJQjcHNKqOv8rCocu7k9T57RIHyVd1hRlXCfSarUuJtZ9ktjlhcpUm0Jyp1FSoz6R3akiBlY+dEOKVddONNvj7a3MpIlfeQJZdgkIrLl1vYRJUPcnaU/w==',
        //     data: 'LkMl6vI4VmcbF7z4Sm7AaZBeb+ZN1InN4FulSghuYSvPwngfdwpxDpNZHTNTi0lo8uS3/xyikA=='
        // }
        // pwd.value = 'WWxDBceX5IKTj55IZes7qPr1ucX1eyUEMBCC1IJka8tN64ACFQKLRumcsqMbEXNmJAZHBRonfBomoYWcLXwsujp4pdcul8BzIZy9Yccf5xY6lmibSkZqha4ppojabdMU6xkIph9YQCCeCrJsEfSspGdpFYLvtxXM5b7XNA0wfsV0fl0hNPbupifb1UaBXAReFepiz4rgpTOrQkJNkbetrNHKYiYhgxon2yT7twXSkv2qwRaGAV1GoHw48ZEDlaHMZnT138SI7E5BS1mqUzUYwPkIMbfPFCB1qIdfzmiIUan6Gp01wbeVTHtEdMu9sd8PTiHQ136D0SVoTiQErsevGAL2IgZRWAGLFJxFhA0LURZJLNI9gculZy2uKxydhnBAIYKqkWGOmoWTjbU0q76gGqVk85gCtnwvyW82bx3ApmkIl7Fv6y5FQxsBhZs5uSA3ROHmEH6RjSA9m73nZhxSt37bnKmHDGCJuI3DeVJNnman58eXxrGDAyrSnXUVnwQ7'

        // Production:
        const pl = /*{{ENCRYPTED_PAYLOAD}}*/""

        const find = document.querySelector.bind(document)
        const [pwd, iframe, header, msg, locked, unlocked] = [
            'input',
            'iframe',
            'header',
            '#msg',
            '#locked',
            '#unlocked',
        ].map(find)

        function show(element) {
            element.classList.remove('hidden')
        }
        function hide(element) {
            element.classList.add('hidden')
        }

        function error(text) {
            msg.innerText = text
            header.classList.toggle('text-red-600', true)
            header.classList.toggle('text-green-600', false)
            show(locked)
            hide(unlocked)
        }

        function success(text) {
            msg.innerText = text
            header.classList.toggle('text-green-600', true)
            header.classList.toggle('text-red-600', false)
            show(unlocked)
            hide(locked)
        }

        function status(text) {
            msg.innerText = text
            header.classList.toggle('text-green-600', false)
            header.classList.toggle('text-red-600', false)
            show(locked)
            hide(unlocked)
        }

        async function sleep(milliseconds) {
            return new Promise(resolve => setTimeout(resolve, milliseconds))
        }

        find('form').addEventListener('submit', async (event) => {
            event.preventDefault()

            try {
                status('Decrypting...')
                await sleep(60)
                const decrypted = decryptFile(pl, pwd.value)
                if (!decrypted) throw 'Malformed data'

                success('Success!')

                // Set default iframe link targets to _top so all links break out of the iframe
                iframe.srcdoc = decrypted.replace(
                    '<head>',
                    '<head><base href="." target="_top">',
                )

                window.setTimeout(() => {
                    find('main').remove()
                    show(iframe)
                    find('body > script').remove()
                }, 1000)
            } catch (e) {
                error('Wrong password.')
                pwd.value = ''
            }
        })

        if (pl === '') {
            pwd.disabled = true
            error('No encrypted payload.')
        }

        function decryptFile(pl, password) {
            const salt = forge.util.decode64(pl.salt)
            const key = forge.pkcs5.pbkdf2(password, salt, 1e5, 32)

            const decipher = forge.cipher.createDecipher('AES-GCM', key)
            decipher.start({
                iv: forge.util.decode64(pl.iv),
                tag: new forge.util.ByteStringBuffer(forge.util.decode64(pl.tag)),
            })
            decipher.update(forge.util.createBuffer(forge.util.decode64(pl.data)))
            decipher.finish()

            const decryptedBuffer = forge.util.createBuffer()
            decryptedBuffer.putBuffer(decipher.output)
            return decryptedBuffer.toString()
        }
    </script>
</body>

</html>