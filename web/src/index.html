<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="style.css">
    <title>Protected Page</title>
</head>

<body>
    <iframe class="hidden w-full h-screen" allowfullscreen></iframe>

    <main class="bg-yellow-200 w-full h-screen flex items-start justify-center tracking-wide font-light">
        <div class="max-w-sm w-full bg-gray-50 p-4 rounded-sm shadow-2xl mt-40">
            <header class="flex gap-2 mb-4">
                <svg id="locked" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"
                    xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd"
                        d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                        clip-rule="evenodd"></path>
                </svg>
                <svg id="unlocked" class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20"
                    xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2H7V7a3 3 0 015.905-.75 1 1 0 001.937-.5A5.002 5.002 0 0010 2z">
                    </path>
                </svg>
                <p id="msg">This page is password protected.</p>
            </header>
            <form>
                <input type="password" id="pwd" name="pwd" aria-label="Password" autofocus placeholder="Password"
                    class="font-extralight bg-gray-200 flex w-full py-2 px-4 tracking-wider rounded-sm focus:outline-none text-black placeholder-black text-opacity-100 focus:border-black border" />
            </form>
        </div>
    </main>

    <script type="module">
        import CryptoJS from 'crypto-js'

        // Testing:
        const pl = { "salt": "FecHK+PExiCscrZ9SDW667kpR/HiayN6kaB5oo/fKIk=", "iv": "+4FDx+36B4HpB0JwL5i0XQ==", "data": "VcXyVUi8A4/UOTOGg9XCn/cFdMUpg60JKSvOo7M8qTc9e4XaiGXmaOFwYtFbqwegbB1uANylaey42R3P8dAa4KRIUoTD4NSnC/YTmfo6huIb1BR6HqW6ejGm8liGhqlKblbYzsmIkHI5gs8gjs/LNu07t7QDg1ym2mCiMjBVuthRrxe0BtNBc57PCwBELPE59PL98ytECOlLeO+4FHppgGUYifVOJN0HtHkQ1W3VI5tCk3utolTRSECY07MgcH4oK8qH026HYFuynlvl9EfuWi/Ll4gbRXVJnkN0WhAmJHPYasdLfC0IRX8RgtusPNNeHLFuBDoE+J7AsAcGX5EsVm97XbRnwys5S3QFtok6bDHajulYB6rh4Aoly/bz6gdyc4OYVdhT2rgpOxTckg3atg==" }
        // Production:
        // const pl = /*{{ENCRYPTED_PAYLOAD}}*/""

        const find = document.querySelector.bind(document)
        const [pwd, iframe, header, msg, locked, unlocked] = [
            'input',
            'iframe',
            'header',
            '#msg',
            '#locked',
            '#unlocked',
        ].map(find)

        function show(element) {
            element.classList.remove('hidden')
        }
        function hide(element) {
            element.classList.add('hidden')
        }

        function error(text) {
            msg.innerText = text
            header.classList.toggle('text-red-600', true)
            header.classList.toggle('text-green-600', false)
            show(locked)
            hide(unlocked)
        }

        function success(text) {
            msg.innerText = text
            header.classList.toggle('text-green-600', true)
            header.classList.toggle('text-red-600', false)
            show(unlocked)
            hide(locked)
        }

        find('form').addEventListener('submit', (event) => {
            event.preventDefault()

            try {
                let decrypted = decryptFile(
                    CryptoJS.enc.Base64.parse(pl.data),
                    pwd.value,
                    CryptoJS.enc.Base64.parse(pl.salt),
                    CryptoJS.enc.Base64.parse(pl.iv),
                )
                if (!decrypted) throw 'Malformed data'

                success('Success!')

                // Set default iframe link targets to _top so all links break out of the iframe
                decrypted = decrypted.replace(
                    '<head>',
                    '<head><base href="." target="_top">',
                )

                iframe.srcdoc = decrypted

                window.setTimeout(function () {
                    find('main').remove()
                    show(iframe)
                }, 1000)
            } catch (e) {
                error('Wrong password.')
                pwd.value = ''
            }
        })

        if (pl === '') {
            pwd.disabled = true
            error('No encrypted payload.')
        }

        function decryptFile(contents, password, salt, iv) {
            const _cp = CryptoJS.lib.CipherParams.create({
                ciphertext: contents,
            })
            const key = CryptoJS.PBKDF2(password, salt, {
                keySize: 256 / 32,
                iterations: 100,
            })
            const decrypted = CryptoJS.AES.decrypt(_cp, key, { iv })

            return decrypted.toString(CryptoJS.enc.Utf8)
        }
    </script>
</body>

</html>